<div class="container mt-5" *ngIf="eventId">
  <h2 class="mb-4">Commentaires pour l'événement </h2>

  <!-- Feedback List -->
  <div class="feedback-list mb-5">
    <div *ngFor="let fb of feedbacks" class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <strong>Utilisateur {{ fb.id_user }}</strong>
            <span class="text-warning ms-3">
              {{ '★'.repeat(fb.rate) }}{{ '☆'.repeat(5 - fb.rate) }}
            </span>
            <p class="mt-2 mb-1">{{ fb.content }}</p>
            <small class="text-muted">{{ fb.date | date:'medium' }}</small>
          </div>

          <div class="btn-group" *ngIf="fb.id_user === currentUserId">
            <button class="btn btn-sm btn-outline-primary" (click)="startEdit(fb)">
              Edit
            </button>
            <button class="btn btn-sm btn-outline-danger" (click)="deleteFeedback(fb.id!)">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="feedbacks.length === 0" class="text-center text-muted py-4">
      Aucun commentaire pour le moment. Soyez le premier !
    </div>
  </div>

  <!-- Form -->
  <div class="card">
    <div class="card-header">
      <h4>{{ isEditing ? 'Modifier le commentaire' : 'Laisser un commentaire' }}</h4>
    </div>
    <div class="card-body">
      <form #feedbackForm="ngForm" (ngSubmit)="onSubmit()">

        <!-- Star rating -->
        <div class="mb-3">
          <label class="form-label fw-bold">Note (1 à 5)</label>
          <div>
            <span *ngFor="let n of [1,2,3,4,5]"
                  class="star h3 me-1"
                  [class.text-warning]="n <= currentRate"
                  (click)="setRate(n)"
                  style="cursor:pointer;">
              ★
            </span>
            <small class="text-muted ms-2">{{ currentRate }}/5</small>
          </div>
        </div>

        <!-- Comment -->
        <div class="mb-3">
          <label for="content" class="form-label fw-bold">Votre commentaire</label>
          <textarea id="content"
                    class="form-control"
                    rows="4"
                    [(ngModel)]="currentContent"
                    name="content"
                    required
                    minlength="10">
          </textarea>
        </div>

        <!-- Buttons -->
        <div class="d-flex gap-2">
          <button type="submit"
                  class="btn btn-primary"
                  [disabled]="feedbackForm.invalid || currentRate === 0">
            {{ isEditing ? 'Mettre à jour' : 'Publier' }}
          </button>
          <button type="button"
                  *ngIf="isEditing"
                  class="btn btn-secondary"
                  (click)="cancelEdit()">
            Annuler
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Suggested Events in Same Location -->
<div class="mt-5 pt-4 border-top" *ngIf="currentEvent">
  <h3 class="mb-4 text-center fw-bold">
    Autres événements à {{ currentEvent.location }}
  </h3>

  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    <div class="col" *ngFor="let event of similarEvents">
      <app-card [e]="event"></app-card>
    </div>
  </div>

  <div class="text-center text-muted py-5" *ngIf="similarEvents.length === 0">
    <p>Aucun autre événement à {{ currentEvent.location }} pour le moment.</p>
  </div>
</div>